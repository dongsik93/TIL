# 11강 이더리움 스마트계약2

### 이더리움 통화

- ETH의 발행

  - 참여자간의 지불 거래와 거래 수수료 지불을 위해 자체화폐(ETH) 발행
  - 초기 이더리움 프로젝트 수행 비용 조달을 위해 크라우드 세일(Crowd Sale) 방식으로 72,009,990,49948 ETH 선 발행
  - 이후 약 14초 마다 블록 채굴 보상금으로 일정액의 ETH를 계속 발행
  - 블록 보상 : 정규 블록 보상 (5ETH → 3ETH), 삼촌 불록 보상(87.5%), 조카 블록 보상(3.125%)


### 스마트 계약의 실행

- 가스 공급 기반의 거래를 통한 실행
  - 거래 실행 시에 실행에 요구되는 명령(instructions)의 종류와 수에 상응하는 비용을 지불
  - 자체 통화인 이더(ETH) 기반의 가스 공급(gas fueling) 메커니즘을 거래 실행에 도입
  - 이더리움의 거래는 소비할 수 있는 가스 한도를 명시하므로 무한정 많은 량의 가스 소비가 불가능
  - 공격자가 무한 루프를 사용한 DoS 공격 시도 불가

- 거래 유형
  - 계약 생성 거래(contract creation transaction)
    - EOA의 참여자가 Solidity 등으로 계약 프로그램을 작성하여 블록체인에 실장하기 위해 네트워크로 송신
    - 채굴자에 의해 처리되어 블록체인에 저장되면 해당 계약 프로그램에 의해 제어되는 CA가 생성되고 CA의 주소가 반환
  - 메시지 전송 거래(message transfer transaction)
    - 송신자 계좌와 수신자 계좌 간에 메시지를 전송
    - 수신 계좌가 EOA인 경우 메시지는 단순히 ETH 통화를 포함
    - 수신 계좌가 CA인 경우 CA의 계약 프로그램의 특정 함수를 호출하는 데 필요한 데이터를 추가로 포함 가능
- 거래 자료 구조
  - 넌스(nonce)
  - 가스가격(gasPrice)
  - 가스한도(gasLimit)
  - 수신자(to)
  - 값(value)
  - v, r, s(공개키와 주소 복구가 가능한 서명 정보)
  - 시작코드(init)
  - 데이터(data)



### 스마트 계약 실행을 위한 가스 공급

- 가스 - 암호 연료
  - 이더리움 거래 수수료는 필수로 설정
  - 거래 실행에 포함되는 명령의 종류와 수에 의해 결정
  - 송신자가 지불한 전체 수수료에서 거래 실행 과정에서 수행되는 명령 마다 필요한 수수료를 사용
  - 거래 실행이 안료되면 지불된 전체 수수료 중 명령 수행에 사용된 수수료를 제외한 나머지를 송신자 계좌에 반환





# 제12강 이더리움 블록채굴과 합의프로토콜1

### 이더리움의 블록 채굴과 합의

- 목적
  - 누구나 블록 생성자(채굴자)로 참여 가능
  - 채굴자들의 합의로 거래들이 블록체인에 저장되는 순서를 정의하고, 동기화된 블록체인 유지를 보장

- 기본 정책

  - 작업 증명(proof of work) 기반의 블록 생성
  - 채굴자에게 블록 인센티브(block incentives) 지불

- 설계 목표

  - 거래 승인 성능 향상

    → 10초 단위의 블록 생성

  - 작업 증명 자원 낭비 축소(블록 생성간격 대비 전달시간 비중 상승에 따른)

    → 수정 GHOST 프로토콜

  - 채굴 역량 집중화 방지(ASIC화에 따른)

    → 메모리 하드(memory-hard) 형 Ethash 작업 증명 알고리즘



### 블록 생성 간격

- 블록 생성 간격과 난이도 조절
  - 블록 생성 간격이 10~19초 이내가 되도록 조정
  - 부모 블록과의 시간 간격이 9초 이하이면 난이도 상향
  - 20초 이상이면 난이도 하향 조정
- 짧은 블록 생성 간격의 문제점
  - 블록 전달지연시간 비중이 커짐
  - 블록 전달시간 동안 생성되는 부실 블록 발생률 상승
- 부실 블록(stale block)
  - 적합하게 생성된 블록이지만 다른 채굴자에 의해 생성된 블록과의 승인 경쟁에서 패배하여 메인 체인에 포함되지 못하고 브랜치에 연결된 블록
- 부실 블록의 문제점
  - 채굴 역량이 높은 채굴자가 다음 블록 채굴 조기 개시확률이 높음
  - 채굴 역량 집중화 심화 초래 → 네트워크 안전성 훼손



### 수정 GHOST 프로토콜

- 이더리움의 수정 GHOST 프로토콜

  - 최장 체인 대신 GHOST 프로토콜을 기본적으로 채택
  - 구현의 복잡성을 고려하여 단순화된 GHOST 프로토콜 적용
  - 삼촌 블록(uncle block) : 수정 GHOST 프로토콜에서 포함하는 부실 블록





  - 새롭게 생성되는 블록은 부모 블록을 지정하여야 하고, 0~2개까지의 삼촌 블록을 포함할 수 있다.
  - 새로운 블록에 포함되는 삼촌 블록은 2대의 부모 블록부터 시작하여 7대까지의 조상 블록에 직접 연결된 자식 블록이어야 한다.
  - 삼촌 블록은 새로운 블록의 조상 블록이 아니어야 한다.
  - 삼촌 블록은 적합한 블록 헤더를 가져야 한다.
  - 삼촌 블록은 이전 블록에 포함된 블록이 아니어야 하고, 같은 블록에 포함된 다른 블록과 동일하지 않아야 한다.(이중 포함 금지)
  - 삼촌 블록의 채굴자와 삼촌 블록을 포함시키는 블록(조카 블록)의 채굴자는 그에 따른 소정의 블록 인센티브를 지불 받는다.



### 블록 선택 : GHOST 프로토콜

- GHOST(Greedy Heaviest Observed Subtree) 프로토콜
  - 비트코인 : 최장 길이 체인(longest chain)을 메인 체인으로 선택
  - 이더리움 : 가장 무거운 서브 트리(heaviest subtree)의 최장 길이 체인을 메인 체인으로 선택

- GHOST 프로토콜 안전성
  - 공격자가 B2 블록으로 교체하려면 B1 블록 이후에 현재 연결되어 있는 10개의 블록보다 많은 11개 이상의 블록을 생성해야 함
  - 부실 블록이 블록체인 조작 방지에 기여 → 네트워크 안전성 제고
- 부실 브록과 거래의 적합성
  - 메인 체인의 블록의 거래들만 승인된 거래로 인정